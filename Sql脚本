WITH DataSource AS
(
  SELECT
    '0174' AS InterfaceId,
    '0' AS ErrorClassification,
    CASE 
        WHEN ISNULL(OrderSource, '') = '' THEN NULL 
        WHEN OrderSource <> CustomerPoNumber THEN CONCAT(SUBSTRING(OrderSource, 1, 2), SUBSTRING(CONVERT(VARCHAR(10), IF0174Seq), 3, 8))
        ELSE OrderSource
    END AS OhiId,
    '0' AS Status,
    CASE 
        WHEN ISNULL(OrderSource, '') = '' THEN NULL 
        WHEN OrderSource <> CustomerPoNumber THEN CONCAT(SUBSTRING(OrderSource, 1, 3), IF0174Seq)
        ELSE OrderSource
    END AS OrigSysDocumentRef,
    CONVERT(INT, NULLIF(OrderSource, '')) AS OrderSource,
    CustomerPoNumber,
    CustomerNumber,
    ShipmentPriorityCode,
    ShipToOrgCode,
    OrganizationCode,
    CASE 
        WHEN ISNULL(OrderSource, '') = '' THEN NULL 
        WHEN OrderSource <> CustomerPoNumber THEN CONCAT(SUBSTRING(OrderSource, 1, 2), SUBSTRING(CONVERT(VARCHAR(10), IF0174Seq), 3, 8))
        ELSE OrderSource
    END AS OliId,
    OrigSysLineRef,
    InventoryItemSegment1,
    OrderedQuantity,
    InvoiceToOrgCode,
    '' As ErrorMessage,
    '' AS SalesTableOIFRecId,
    ROW_NUMBER() OVER(PARTITION BY OrderSource, CustomerPoNumber ORDER BY OhiId) AS NewOhiId -- 新增的窗口函数
  FROM earth_dp_SpoonsOrderIF_LS_IF_0174_TempWithSeq
)
UPDATE DataSource
SET OhiId = NULL
WHERE OrderSource = '';

UPDATE DataSource
SET OhiId = OrigSysDocumentRef
WHERE OhiId IS NULL;

UPDATE DataSource
SET OhiId = OrigSysDocumentRef
WHERE OhiId IS NOT NULL AND OhiId <> OrigSysDocumentRef AND OrderSource = CustomerPoNumber;

SELECT
  CustomerNumber,
  CustomerPoNumber,
  ErrorClassification,
  ErrorMessage,
  InterfaceId,
  InventoryItemSegment1,
  InvoiceToOrgCode,
  OhiId,
  OliId,
  OrderSource,
  OrderedQuantity,
  OrganizationCode,
  OrigSysDocumentRef,
  OrigSysLineRef,
  SecondaryInventoryName,
  ShipToOrgCode,
  ShipmentPriorityCode,
  SalesTableOIFRecId,
  Status
FROM DataSource;
