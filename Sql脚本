WITH DataSource AS (
    SELECT
        '0174' AS InterfaceId,
        '0' AS ErrorClassification,
        CASE 
            WHEN OrderSource IS NULL THEN ''
            ELSE CONCAT(SUBSTRING(OrderSource, 1, 2), SUBSTRING(CONVERT(VARCHAR(10), IF0174Seq), 3, 8))
        END AS OhiId,
        '0' AS Status,
        '' As OrigSysDocumentRef,
        OrderSource,
        CustomerPoNumber,
        CustomerNumber,
        ShipmentPriorityCode,
        ShipToOrgCode,
        OrganizationCode,
        SecondaryInventoryName,
        CASE 
            WHEN OrderSource IS NULL THEN ''
            ELSE CONCAT(SUBSTRING(OrderSource, 1, 2), SUBSTRING(CONVERT(VARCHAR(10), IF0174Seq), 3, 8))
        END AS OliId,
        OrigSysLineRef,
        InventoryItemSegment1,
        OrderedQuantity,
        InvoiceToOrgCode,
        '' As ErrorMessage,
        '' As SalesTableOIFRecId,
        ROW_NUMBER() OVER(PARTITION BY OrderSource, CustomerPoNumber ORDER BY OhiId) AS NewOhiId
    FROM earth_dp_SpoonsOrderIF_LS_IF_0174_TempWithSeq
),
PreviousOhiId AS (
    SELECT 
        *,
        LAG(OhiId) OVER (ORDER BY OhiId) AS PreviousOhiId
    FROM DataSource
)
SELECT
    CustomerNumber,
    CustomerPoNumber,
    ErrorClassification,
    ErrorMessage,
    InterfaceId,
    InventoryItemSegment1,
    InvoiceToOrgCode,
    CASE 
        WHEN po.PreviousOhiId = ds.OrderSource AND po.CustomerPoNumber = ds.CustomerPoNumber
        THEN COALESCE(po.PreviousOhiId, ds.OhiId) -- 如果与前一行的OrderSource和CustomerPoNumber相同，则返回前一行的OhiId
        ELSE ds.OhiId -- 否则保持当前行的OhiId不变
    END AS OhiId,
    OliId,
    OrderSource,
    OrderedQuantity,
    OrganizationCode,
    OrigSysDocumentRef,
    OrigSysLineRef,
    SecondaryInventoryName,
    ShipToOrgCode,
    ShipmentPriorityCode,
    SalesTableOIFRecId,
    Status
FROM DataSource ds
LEFT JOIN PreviousOhiId po ON ds.OhiId = po.OhiId;
