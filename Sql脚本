WITH DataSource AS (
    SELECT
        InterfaceId,
        ErrorClassification,
        CASE 
            WHEN OrderSource IS NULL THEN ''
            ELSE CONCAT(SUBSTRING(OrderSource, 1, 2), SUBSTRING(CONVERT(VARCHAR(10), IF0174Seq), 3, 8))
        END AS OhiId,
        Status,
        OrigSysDocumentRef,
        OrderSource,
        CustomerPoNumber,
        CustomerNumber,
        ShipmentPriorityCode,
        ShipToOrgCode,
        OrganizationCode,
        SecondaryInventoryName,
        IIF(
            ISNULL(OrderSource, ''),
            OrderSource,
            CONCAT(SUBSTRING(OrderSource, 1, 2), SUBSTRING(CONVERT(VARCHAR(10), IF0174Seq), 3, 8))
        ) AS OliId,
        OrigSysLineRef,
        InventoryItemSegment1,
        OrderedQuantity,
        InvoiceToOrgCode,
        ErrorMessage,
        SalesTableOIFRecId,
        LAG(OhiId) OVER (PARTITION BY OrderSource, CustomerPoNumber ORDER BY OhiId) AS PreviousOhiId, -- 获取前一行的OhiId
        ROW_NUMBER() OVER(PARTITION BY OrderSource, CustomerPoNumber ORDER BY OhiId) AS NewOhiId
    FROM earth_dp_SpoonsOrderIF_LS_IF_0174_TempWithSeq
)
SELECT
    CustomerNumber,
    CustomerPoNumber,
    ErrorClassification,
    ErrorMessage,
    InterfaceId,
    InventoryItemSegment1,
    InvoiceToOrgCode,
    CASE 
        WHEN LAG(OrderSource) OVER (PARTITION BY OrderSource, CustomerPoNumber ORDER BY OhiId) = OrderSource
             AND LAG(CustomerPoNumber) OVER (PARTITION BY OrderSource, CustomerPoNumber ORDER BY OhiId) = CustomerPoNumber
        THEN LAG(OhiId) OVER (PARTITION BY OrderSource, CustomerPoNumber ORDER BY OhiId) -- 如果与前一行的OrderSource和CustomerPoNumber相同，则返回前一行的OhiId
        ELSE OhiId -- 否则保持当前行的OhiId不变
    END AS OhiId,
    OliId,
    OrderSource,
    OrderedQuantity,
    OrganizationCode,
    OrigSysDocumentRef,
    OrigSysLineRef,
    SecondaryInventoryName,
    ShipToOrgCode,
    ShipmentPriorityCode,
    SalesTableOIFRecId,
    Status
FROM DataSource;
